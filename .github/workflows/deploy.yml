name: Deploy to Aliyun Production

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            set -e  # <--- 加上这一行，遇到错误立即停止
            
            echo "====== 开始部署 ======"
            
            # 1. 进入项目目录
            cd /data/admin
            
            # 2. 强制同步代码
            echo "正在拉取最新代码..."
            git fetch --all
            git reset --hard origin/main
            
            # 3. 重新构建并启动容器
            echo "正在构建并重启 Docker 容器..."
            docker-compose up -d --build
            
            # 4. 清理垃圾镜像
            echo "正在清理旧镜像..."
            docker image prune -f
            
            echo "====== 部署完成 ======"